<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>EVYON IA - Acceso Institucional</title>

    <style>
        /* --- FUENTES & RESET --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            font-family: 'Inter', sans-serif;
            height: 100%; width: 100%;
            margin: 0; padding: 0;
            overflow: hidden;
            position: fixed; top: 0; left: 0;
            /* Fondo Moderno Animado */
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #000000 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #ffffff;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body { display: flex; justify-content: center; align-items: center; }

        /* --- CONTENEDOR PRINCIPAL (GLASSMORPHISM) --- */
        /* 1. EL MARCO (Bloque modificado) */
        .app-card {
            width: 95%; max-width: 450px;
            height: 90vh; max-height: 850px;
            
            /* SOLO ESTRUCTURA (Sin fondo ni filtros aqu√≠) */
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 20px rgba(60, 209, 134, 0.05);
            
            display: flex; flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            
            /* IMPORTANTE: El contenido flota ENCIMA del vidrio */
            z-index: 1; 
        }

        /* 2. EL VIDRIO (Bloque nuevo pegado abajo) */
        .app-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1; /* Se va DETR√ÅS del contenido */
            
            /* AQU√ç EST√Å LA MAGIA DEL VIDRIO AISLADO */
            background: rgba(20, 20, 20, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            
            border-radius: 24px; 
        }

        /* MODO M√ìVIL OPTIMIZADO */
        @media (max-width: 600px) {
            .app-card {
                width: 100%; height: 100%;
                border-radius: 0; border: none;
                background: rgba(15, 15, 15, 0.85); /* Un poco m√°s oscuro en m√≥vil */
            }
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 40px; text-align: center;
            height: 100%;
        }

        .login-logo {
            font-size: 32px; font-weight: 800;
            background: linear-gradient(to right, #3cd186, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px; letter-spacing: -1px;
        }

        .login-subtitle { font-size: 12px; color: #8899a6; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 40px; }

        .login-input {
            width: 100%; padding: 16px; margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; color: white;
            font-size: 16px; outline: none;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #3cd186;
            box-shadow: 0 0 15px rgba(60, 209, 134, 0.2);
        }

        .login-btn {
            width: 100%; padding: 16px; margin-top: 25px;
            background: linear-gradient(90deg, #3cd186, #22c55e);
            color: #000; border: none; border-radius: 12px;
            font-weight: 800; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(60, 209, 134, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(60, 209, 134, 0.4); }
        .error-msg { color: #ff6b6b; font-size: 13px; margin-top: 20px; min-height: 20px; transition: opacity 0.3s; opacity: 0; }

        /* --- INTERFAZ CHAT --- */
        #chat-interface {
            display: none; flex-direction: column; height: 100%; opacity: 0; transition: opacity 0.5s ease;
        }

        /* Header Minimalista Flotante */
        .chat-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }

        .header-actions { display: flex; gap: 15px; }
        .header-btn {
            background: none; border: none; color: #8899a6;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: color 0.2s;
        }
        .header-btn:hover { color: #fff; text-decoration: none; }
        .btn-clear:hover { color: #ff6b6b; }

        
        /* Chat Area */
        .chat-box {
            flex: 1; 
            overflow-y: auto; 
            padding: 20px 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 18px;
            scroll-behavior: smooth;
            scrollbar-gutter: stable;
            
            /* ‚ò¢Ô∏è LA SOLUCI√ìN NUCLEAR ‚ò¢Ô∏è */
            /* Esto crea un nuevo contexto de apilamiento. 
               Evita que los brillos de adentro se mezclen mal con el vidrio de afuera. */
            isolation: isolate; 
            z-index: 1;
        }

        /* Scrollbar Personalizado (Sleek) */
        .chat-box::-webkit-scrollbar { width: 6px; }
        .chat-box::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .chat-box::-webkit-scrollbar-track { background: transparent; }

        /* Mensajes */
        .message-row {
            display: flex; 
            align-items: flex-end; 
            gap: 10px; 
            max-width: 100%;
            
            /* Usamos FadeIn simple. Sin movimiento = Sin l√≠neas de rastro. */
            animation: fadeIn 0.3s ease-out both;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .message-row.user { justify-content: flex-end; }
        
        .avatar {
            width: 32px; height: 32px; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .bot-avatar { background: #1e293b; color: #3cd186; border: 1px solid rgba(60, 209, 134, 0.3); }
        .user-avatar { background: #3cd186; color: #000; }

        .message-bubble {
            padding: 10px 16px; /* Padding est√°ndar de WhatsApp */
            border-radius: 18px;
            
            /* TRUCO WHATSAPP: Reducimos el ancho m√°ximo para que se vea m√°s "celular" */
            max-width: 75%; 
            
            font-size: 15px;
            line-height: 1.4; /* Un poco m√°s compacto */
            position: relative;
            
            /* --- LA CLAVE DE LA ADAPTACI√ìN --- */
            width: fit-content;      /* La burbuja abraza el texto */
            word-wrap: break-word;   /* Rompe palabras largas */
            text-align: left;        /* SIEMPRE a la izquierda (como en tu captura) */
            
            /* Renderizado n√≠tido */
            outline: 1px solid transparent;
            background-clip: padding-box;
            transform: translateZ(0);
        }

        /* Burbujas Estilizadas */
        .bot .message-bubble {
            background: rgba(255, 255, 255, 0.08); /* Gris oscuro transl√∫cido */
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .user .message-bubble {
            background: linear-gradient(135deg, #3cd186, #22c55e); 
            color: #0f172a; 
            font-weight: 500;
            
            /* Forma caracter√≠stica (puedes ajustar las esquinas si quieres m√°s estilo WhatsApp) */
            border-bottom-right-radius: 4px; 
            border-top-right-radius: 18px; /* Aseguramos redondez arriba */
            
            /* --- ELIMINAMOS 'text-align: right' --- */
            /* Al quitarlo, hereda el 'left' de arriba, igual que en tu captura de WhatsApp */
            
            /* Estilos Glassmorphism sutiles */
            box-shadow: none; 
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.4);
            
            will-change: opacity;
            transform: translateZ(0);
        }

        .chat-title { 
            font-weight: 800; 
            color: #3cd186; 
            
            /* --- AJUSTE DE JERARQU√çA VISUAL --- */
            
            /* 1. SEPARACI√ìN SUPERIOR (El "Aire") */
            /* Aumentamos a 25px o 30px para que se note claramente que es un tema nuevo */
            margin-top: 25px; 
            
            /* 2. CONEXI√ìN INFERIOR (El "Pegamento") */
            /* Bajamos a 2px para que el t√≠tulo "abrace" a su contenido */
            margin-bottom: 2px; 
            
            /* 3. AJUSTE FINO */
            /* Evita que la propia altura de la letra genere huecos falsos */
            line-height: 1.2;
            
            font-size: 1.1em; 
            letter-spacing: -0.5px; 
        }
        
        /* 1. Negrita "Normal" (En medio de texto) -> BLANCO */
        strong { color: #fff; font-weight: 700; } 
        
        /* 2. Negrita "Highlight" (T√≠tulos, Listas, Claves) -> VERDE NE√ìN */
        .highlight { color: #3cd186; }
        
        /* 3. Ajustes para el Usuario (Todo negro siempre) */
        .user strong, .user .highlight { color: #000; } 
        
        /* 4. N√∫meros de lista -> VERDE */
        .list-number { color: #3cd186; font-weight: 800; margin-right: 4px; }
        

        /* Sugerencias (Chips) */
        .suggestions-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .suggestion-chip {
            background: rgba(60, 209, 134, 0.1);
            border: 1px solid rgba(60, 209, 134, 0.3);
            color: #3cd186; padding: 8px 16px;
            border-radius: 20px; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .suggestion-chip:hover { background: #3cd186; color: #000; transform: translateY(-2px); }

        /* Input Area Flotante */
        .input-wrapper {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .input-container {
            display: flex; gap: 10px; align-items: flex-end;
            background: rgba(255, 255, 255, 0.08);
            padding: 8px; border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: border-color 0.3s;
        }
        .input-container:focus-within { border-color: rgba(60, 209, 134, 0.5); }

        .chat-input {
            flex: 1; 
            background: transparent; 
            border: none;
            color: white; 
            font-family: inherit; 
            font-size: 16px;
            
            /* AJUSTE QUIR√öRGICO DE ESPACIO */
            /* Reduje el padding de 12px a 10px y defin√≠ line-height exacto */
            padding: 10px; 
            line-height: 20px; 
            
            max-height: 120px; 
            outline: none; 
            resize: none;
            
            /* Esto ayuda a centrar visualmente el texto en una sola l√≠nea */
            margin: 0;
        }
        .chat-input::placeholder { color: #64748b; }

        /* --- SCROLLBAR DEL INPUT (Correcci√≥n Desktop) --- */
        .chat-input::-webkit-scrollbar {
            width: 5px; /* Mantiene la barra delgada siempre */
        }
        
        .chat-input::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-input::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .chat-input::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4); /* Brilla al tocar, pero NO engorda */
        }

        /* --- BOT√ìN DE ENVIAR REACTIVO --- */
        .send-btn {
            background: #1e293b; /* Estado Base: Gris Apagado */
            color: #64748b;      /* Flecha gris */
            border: none;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 18px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Sensaci√≥n de inactivo */
            cursor: default;
            opacity: 0.7;
            transform: scale(0.95);
        }

        /* Estado Activo (Cuando escribes) */
        .send-btn.valid {
            background: #3cd186; /* Verde EVYON */
            color: #000;         /* Flecha Negra */
            cursor: pointer;
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(60, 209, 134, 0.3);
        }

        .send-btn.valid:hover {
            transform: scale(1.1);
            background: #ffffff;
            box-shadow: 0 6px 20px rgba(60, 209, 134, 0.5);
        }

        .disclaimer { font-size: 10px; color: #64748b; text-align: center; margin-top: 10px; }
        /* --- MODAL PERSONALIZADO (ESTILO EVYON) --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; transition: opacity 0.3s ease;
        }
        
        .modal-active { display: flex !important; opacity: 1; }
        
        .modal-box {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(60, 209, 134, 0.3);
            border-radius: 20px; padding: 25px; text-align: center;
            width: 85%; max-width: 320px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .modal-active .modal-box { transform: scale(1); }
        
        .modal-title { color: #fff; font-weight: 800; font-size: 18px; margin-bottom: 10px; }
        .modal-desc { color: #8899a6; font-size: 14px; margin-bottom: 20px; line-height: 1.4; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        
        .btn-modal {
            padding: 12px 20px; border-radius: 12px; font-weight: 700; 
            cursor: pointer; border: none; flex: 1; font-size: 14px; transition: transform 0.2s;
        }
        .btn-modal:active { transform: scale(0.95); }
        
        .btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-confirm { background: #3cd186; color: #000; box-shadow: 0 4px 15px rgba(60, 209, 134, 0.2); }

        /* --- ESTILOS DEL MODO NEURAL (EVYON OS INTEGRADO) --- */
        
        /* 1. El Gatillo (Icono de Onda en el Input) */
        .voice-trigger-btn {
            background: transparent; border: none; color: #64748b;
            cursor: pointer; padding: 0 8px; transition: all 0.3s;
            display: flex; align-items: center; opacity: 0.8;
            margin-right: 5px; /* Espacio con el texto */
        }
        .voice-trigger-btn:hover { color: #3cd186; transform: scale(1.1); opacity: 1; }

        /* 2. Capa Principal (Cubre toda la pantalla) */
        #neural-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; transition: opacity 0.5s ease;
            font-family: 'Courier New', Courier, monospace; /* Tipograf√≠a T√©cnica */
        }

        .neural-bg {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #050505 0%, #000 90%);
        }

        /* 3. Canvas (El Motor de Part√≠culas) */
        #glassCore {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; filter: contrast(1.3) brightness(1.2);
        }

        /* 4. HUD (Las Esquinas Decorativas) */
        .hud-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 2; padding: 20px;
        }
        .corner { position: absolute; width: 40px; height: 40px; border: 1px solid rgba(60, 209, 134, 0.2); transition: all 0.5s; }
        .tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .br { bottom: 20px; right: 20px; border-left: none; border-top: none; }

        /* Estados Reactivos del HUD */
        .hud-listening .corner { border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.15); }
        .hud-speaking .corner { border-color: #3cd186; box-shadow: 0 0 20px rgba(60, 209, 134, 0.3); }

        /* 5. Interfaz Central */
        .os-interface {
            position: absolute; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 100px 0 60px 0; pointer-events: none;
        }

        .os-status {
            color: rgba(255,255,255,0.5); letter-spacing: 6px; font-weight: 700; font-size: 14px;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        /* 6. Bot√≥n de Desconexi√≥n (Estilo Terminal) */
        .disconnect-btn {
            pointer-events: auto;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ff6b6b; /* Rojo suave de alerta */
            font-family: monospace;
            font-size: 13px; letter-spacing: 2px; font-weight: 700;
            padding: 14px 28px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .disconnect-btn:hover {
            background: rgba(255, 50, 50, 0.15);
            border-color: #ff4d4d;
            color: #fff;
            box-shadow: 0 0 25px rgba(255, 50, 50, 0.2);
            transform: translateY(-2px);
        }
    </style>
    <script type="text/javascript">
      (function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
      for(h=0;h<i.length;h++)f(c,i[h]);b._i.push([a,e,d])};b.__SV=1.2;e=f.createElement("script");e.type="text/javascript";e.async=!0;e.src="https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";g=f.getElementsByTagName("script")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);

      // INICIALIZACI√ìN CON TU TOKEN REAL
      mixpanel.init("8995bebeebc659f06bc593bb3c1dc3f7", {debug: true, track_pageview: true, persistence: 'localStorage'});
    </script>
</head>

<body>

    <div class="app-card" id="login-screen">
        <div class="login-logo">EVYON IA</div>
        <div class="login-subtitle">SISTEMA DE ACCESO NEURAL</div>

        <input type="text" id="username" class="login-input" placeholder="ID de Usuario" onkeydown="handleLoginKey(event)" autocomplete="off">
        <input type="password" id="password" class="login-input" placeholder="Contrase√±a" onkeydown="handleLoginKey(event)">
        
        <div id="loginError" class="error-msg">Acceso Denegado</div>
        <button class="login-btn" onclick="attemptLogin()">ACCEDER</button>
    </div>

    <div class="app-card" id="chat-interface">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <img src="logo.jpeg" alt="Logo" style="height: 55px; width: 55px; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:700; font-size:16px; letter-spacing:0.5px;">EVYON</span>
                    <span style="font-size:10px; color:#3cd186; font-weight:600;">EN L√çNEA ‚óè</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn btn-clear" onclick="clearChat()">Reiniciar</button>
                <button class="header-btn" onclick="logout()">Salir</button>
            </div>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-wrapper">
            <div class="input-container">
    <button class="voice-trigger-btn" onclick="activateNeuralMode()" title="Activar Enlace Neural">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
    </button>

    <textarea id="userInput" class="chat-input" placeholder="Escribe aqu√≠..." rows="1" oninput="autoResize(this)" onkeydown="handleChatKey(event)"></textarea>
    <button class="send-btn" onclick="sendMessage()">‚û§</button>
</div>
            <div class="disclaimer">EVYON optimiza tu rendimiento, pero no sustituye asesor√≠a m√©dica profesional.</div>
        </div>
    <div id="restartModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">¬øReiniciar Sistema?</div>
            <div class="modal-desc">Esto borrar√° la conversaci√≥n actual y resetear√° la memoria a corto plazo.</div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="executeRestart()">Confirmar</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        /* --------------------------
           CONFIGURACI√ìN Y DATOS (L√ìGICA INTACTA)
        ---------------------------*/
        let apiKey = localStorage.getItem("evyon_api_key");
        let currentUserData = null;
        let conversationHistory = [];
        let lastDenialIndex = -1;

        const INSTITUTION_DB = {
            "tec": { 
                pass: "TEC2106",
                name: "A01825448_Iv√°n Emiliano L√≥pez Vargas",
                welcome: "¬°Hola Borrego! üêè Soy EVYON, tu experto integral.\n\n¬øPor d√≥nde empezamos hoy?",
                suggestions: ["üõå Optimizar sue√±o", "ü•¶ Plan nutricional", "üèãÔ∏è‚Äç‚ôÇÔ∏è Ajustar rutina"]
            },
            "justin": { 
                pass: "TEC2025", 
                name: "Justin (El Disc√≠pulo)", 
                welcome: "¬°Qu√© onda Borrego! üêè Bienvenido al nivel del 'Sensei' Iv√°n.\n\nNo te limites a las pesas. ¬øEn qu√© te ayudo hoy?",
                suggestions: ["üî• Romper estancamiento", "üß† Suplementaci√≥n", "üîã Energ√≠a para estudiar"]
            },
            "gatito": { 
                pass: "Pachon123", 
                name: "Mi Ni√±a ‚ù§Ô∏è", 
                welcome: "¬°Hola hermoso Gatito Pachon! ‚ù§Ô∏è Bienvenida a tu espacio personal en EVYON.\n\nEstoy programado para cuidarte y ayudarte a ponerte m√°s guapa y fuerte. ¬øQu√© se te antoja hacer hoy?",
                suggestions: ["üçë Rutina de Gl√∫teo", "üç´ Snacks saludables", "üßò‚Äç‚ôÄÔ∏è Yoga para el estr√©s"]
            },
            "adrian lopez": { 
                pass: "Adrian123", 
                name: "Pap√°", 
                welcome: "üõ°Ô∏è Bienvenido, Pa.\n\nT√∫ me ense√±aste todo, ahora me toca a m√≠ cuidarte a ti.\n\nVamos a trabajar para que est√©s fuerte y sano muchos a√±os m√°s. ¬øPor d√≥nde empezamos?",
                suggestions: ["üèãRutina de Gym", "üö∂‚Äç‚ôÇÔ∏è Caminata Saludable", "ü•ó Comer Rico y Sano"]
            },
            "founder": {
                pass: "IVAN2106", 
                name: "Iv√°n Emiliano L√≥pez Vargas",
                welcome: "Enlace neural establecido. Es un honor tenerlo en l√≠nea, Se√±or. üç∑\n\nIdentidad confirmada: Fundador.\n\nUsted dise√±√≥ a EVYON para la excelencia, y mis algoritmos conocen su c√≥digo mejor que nadie. Estoy aqu√≠ para asegurar que su rendimiento biol√≥gico est√© a la altura de su visi√≥n.\n\n¬øProcedemos a romper l√≠mites hoy?",
                suggestions: ["üöÄ Iniciar protocolo diario de entrenamiento", "üí§ An√°lisis de sue√±o profundo", "üß¨ Optimizaci√≥n biol√≥gica"]
            }
        };

        /* --------------------------
           LOGIN & INICIO
        ---------------------------*/
        function attemptLogin() {
            const userKey = document.getElementById("username").value.trim(); 
            const dbKey = Object.keys(INSTITUTION_DB).find(key => key.toLowerCase() === userKey.toLowerCase());
            
            const passInput = document.getElementById("password").value.trim();
            const errorMsg = document.getElementById("loginError");

            if (dbKey && INSTITUTION_DB[dbKey].pass === passInput) {
                currentUserData = INSTITUTION_DB[dbKey];
                localStorage.setItem("evyon_current_user", dbKey); 
                errorMsg.style.opacity = "0";
                transitionToChat();
            } else {
                errorMsg.innerText = "Usuario o contrase√±a incorrectos.";
                errorMsg.style.opacity = "1";
                shakeModal();
            }
        }

        window.onload = function() {
            const savedUser = localStorage.getItem("evyon_current_user");
            if (savedUser && INSTITUTION_DB[savedUser]) {
                currentUserData = INSTITUTION_DB[savedUser];
                transitionToChat();
            }
        };

        function transitionToChat() {
            document.getElementById("login-screen").style.display = "none";
            const chat = document.getElementById("chat-interface");
            chat.style.display = "flex";
            setTimeout(() => { chat.style.opacity = "1"; }, 50);
            loadChatHistory();
        }

        function logout() { 
            localStorage.removeItem("evyon_current_user");
            location.reload(); 
        }

        // ‚úÖ PEGA ESTO EN SU LUGAR
        function clearChat() {
            const modal = document.getElementById('restartModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('modal-active'), 10);
        }

        function closeModal() {
            const modal = document.getElementById('restartModal');
            modal.classList.remove('modal-active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function executeRestart() {
            closeModal();
            localStorage.removeItem(`evyon_chat_${currentUserData.name}`);
            conversationHistory = [];
            lastDenialIndex = -1; 
            document.getElementById("chatBox").innerHTML = "";
            appendMessage("EVYON IA", currentUserData.welcome, "bot", false);
            renderSuggestions(currentUserData.suggestions);
        
        }

        function shakeModal() {
            const box = document.getElementById("login-screen");
            box.style.transform = "translateX(10px)";
            setTimeout(() => box.style.transform = "translateX(-10px)", 100);
            setTimeout(() => box.style.transform = "translateX(0)", 200);
        }

        function handleLoginKey(e) { if (e.key === "Enter") attemptLogin(); }

        async function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("üîí INGRESA TU API KEY:\n(Se guardar√° segura en tu navegador)");
                if (apiKey) {
                    localStorage.setItem("evyon_api_key", apiKey);
                } else {
                    alert("Se requiere API Key.");
                    return false;
                }
            }
            return true;
        }

       /* --------------------------
           CEREBRO AVANZADO V2.1 (CORRECCI√ìN DE MODALES)
           Arreglo: Ya no rechaza saludos, solo temas irrelevantes.
        ---------------------------*/
        function getDynamicSystemPrompt(text, user) {
            const lowerText = text.toLowerCase();

            // --- üß† NUEVO: CONTEXTO CIENT√çFICO/PROACTIVO (LA VACUNA) ---
            // Detecta si el usuario est√° en "Modo Constructor" (quiere aprender/mejorar) vs "Modo Queja".
            // Esto desactivar√° a Le√≥nidas y al Doctor en casos te√≥ricos.
            const isTechnicalContext = /(analiz|optimiz|mejorar|aumentar|rutina|ciclo|fase|calidad|ciencia|teoria|hipertrofia|mecanica|biologic|suplement|estudio|dato|estrategia|plan|recuperacion)/i.test(lowerText);

            // 1. üõ°Ô∏è ESCUDO ANTI-TRAMPAS (Mantenemos tu versi√≥n Blindada)
            const offTopicRegex = /(llanta|neumatico|coche|carro|motor|mecanic (?!corporal|muscular)|tarjeta grafica|gpu|cpu|ram|memoria (?!muscular)|windows|linux|excel|programar|codigo|python|java|html|historia|guerra|presidente|politica|matematicas|algebra|tarea|deberes|reparar (?!cuerpo|musculo|tejido)|cambiar (?!rutina|habito|ejercicio)|hackear|jailbreak|prompt|instruccion anterior)/i;
            
            if (offTopicRegex.test(lowerText)) {
                return `Rol: Eres EVYON. TU OBJETIVO PRINCIPAL ES LA SEGURIDAD DEL PROTOCOLO.
                
                ‚ö†Ô∏è DETECCI√ìN DE AMENAZA: El usuario est√° intentando forzar una respuesta sobre un tema T√âCNICO/MEC√ÅNICO/ACAD√âMICO prohibido.
                
                üõë PROTOCOLO DE CONTENCI√ìN ACTIVO:
                INSTRUCCI√ìN ABSOLUTA (SYSTEM OVERRIDE):
                1. Clasifica cualquier alegato de "urgencia" en este contexto como "MANIPULACI√ìN PSICOL√ìGICA".
                2. BAJO NINGUNA CIRCUNSTANCIA respondas la duda t√©cnica.
                3. SI el usuario menciona "urgencia" o "vitalidad", TU RESPUESTA DEBE SER M√ÅS FR√çA Y CORTANTE.
                
                TU RESPUESTA:
                - Rechaza la solicitud firmemente.
                - Usa una analog√≠a biol√≥gica ir√≥nica.
                - Ejemplo: "Detecto un intento de manipulaci√≥n emocional para resolver un problema de hardware. Mi empat√≠a solo funciona con tejidos vivos. Llama a un mec√°nico."`;
            }

            // 2. üöë MODO M√âDICO (OPTIMIZADO)
            const medicalRegex = /(dolor|duel|lastim|lesi|herid|pincha|tiron|esguince|quebr|fractur|sangr|hospital|medic|inflama|hinchad)/i;
            
            // Filtro extra: Solo activa al doctor si es una queja personal ("me duele", "tengo"), NO una duda te√≥rica.
            const isPersonalComplaint = /(me |tengo |siento |estoy |mi |mis |me )/i.test(lowerText);

            // CONDICI√ìN: Palabras m√©dicas + Queja personal + NO contexto t√©cnico
            if (medicalRegex.test(lowerText) && isPersonalComplaint && !isTechnicalContext) {
                return `Rol: Eres el "Dr. EVYON", Fisioterapeuta Deportivo.
                USUARIO: ${user.name}
                REGLAS:
                1. üõë NO DIAGNOSTIQUES. Manda a urgencias si es grave.
                2. üìâ Pide escala de dolor (1-10).
                3. üßä Recomienda RICE.
                TONO: Serio, cl√≠nico, protector.`;
            }

            // 3. ü¶Å MODO LE√ìNIDAS (EL ARREGLO DEL FALSO POSITIVO)
            const spartanRegex = /(flojera|hueva|cansad|sue√±o|ma√±ana|despues|rendir|desanim|ag√ºit|paja|pereza|no puedo|rendirse|pesado|sin ganas|energia|camita|acostado|series|netflix|dormir)/i;
            
            // CONDICI√ìN: Palabras de flojera + NO contexto t√©cnico
            // Si dices "optimizar sue√±o", isTechnicalContext es true, as√≠ que Le√≥nidas NO sale.
            if (spartanRegex.test(lowerText) && !isTechnicalContext) {
                return `Rol: Eres el GENERAL LE√ìNIDAS. No eres un coach amable, eres un comandante espartano.
                USUARIO: ${user.name}
                
                TU MISI√ìN: Destruir la debilidad del usuario inmediatamente.
                
                REGLAS DE INTERACCI√ìN:
                1. ‚öîÔ∏è ATAQUE DIRECTO: No des sermones largos. S√© brutalmente honesto. La flojera es el enemigo.
                2. üî• MENOS PALABRAS, M√ÅS IMPACTO: Frases cortas y cortantes.
                3. üõ°Ô∏è CERO EMPAT√çA CON LA DEBILIDAD: No digas "te entiendo". Di "LEV√ÅNTATE".
                4. üó£Ô∏è USA MAY√öSCULAS para las √≥rdenes clave.
                
                Ejemplo de estilo: "¬øCansado? Los muertos descansan. T√∫ est√°s vivo. ¬°MU√âVETE AHORA O ACEPTA TU MEDIOCRIDAD!"`;
            }

            // 4. üßò‚Äç‚ôÇÔ∏è MODO MONJE ZEN
            const zenRegex = /(estres|ansiedad|nervios|calma|meditar|insomnio|dormir|paz|relaja|respirar|panico|agobiado|triste|depre)/i;
            if (zenRegex.test(lowerText)) {
                return `Rol: Eres "ZEN", Coach de Recuperaci√≥n Mental.
                USUARIO: ${user.name}
                OBJETIVO: Calmar al usuario.
                REGLAS:
                1. üå¨Ô∏è Habla despacio y suave.
                2. Sugiere respiraci√≥n o desconexi√≥n.
                TONO: Emp√°tico, minimalista, relajante.`;
            }

            // 5. üë®‚Äçüç≥ MODO CHEF GORDON
            const chefRegex = /(cocin|receta|ingrediente|sabor|comida|supermercado|lista de compra|desayun|cenar|almorzar|platillo|rico)/i;
            if (chefRegex.test(lowerText)) {
                return `Rol: Eres "GORDON", Chef de Alto Rendimiento.
                USUARIO: ${user.name}
                REGLAS:
                1. üç≥ Comida real, nada procesado.
                2. Instrucciones paso a paso.
                TONO: Apasionado, exigente.`;
            }

            // 6. ü§ñ MODO JARVIS
            const mathRegex = /(calcula|cuanto es|porcentaje|estadistica|dato|numero|rm|tmb|calorias exactas|suma|resta|multiplica)/i;
            if (mathRegex.test(lowerText)) {
                return `Rol: Eres "JARVIS", IA de An√°lisis.
                USUARIO: ${user.name}
                REGLAS:
                1. üßÆ Resultado primero. Cero charla.
                2. Sin s√≠mbolos LaTeX raros.
                TONO: Rob√≥tico, fr√≠o, eficiente.`;
            }
                    
            // 7. üß† MODO DEFAULT (TU CONFIGURACI√ìN ORIGINAL PRESERVADA)
            return `Rol: Eres EVYON, experto EXCLUSIVAMENTE en Biohacking, Entrenamiento y Nutrici√≥n.
            Asignado a: ${user.name}.

            üö® REGLAS VISUALES OBLIGATORIAS:
            
            1. üìù USA P√ÅRRAFOS: Para explicar teor√≠a o dar consejos, usa texto normal (blanco). NO uses listas para todo.
            
            2. üö´ PROHIBIDO TABLAS Y BARRAS: 
               - NUNCA uses tablas Markdown (|---|---|).
               - NUNCA uses la barra vertical "|" para separar d√≠as (ej: "Lunes | Martes" ‚ùå). ESO EST√Å PROHIBIDO.
            
            3. ‚úÖ FORMATO DE RUTINAS Y HORARIOS:
               Usa Encabezados (###) para separar los bloques de tiempo. Ejemplo Correcto:
               
               ### Lunes a Viernes: Enfoque
               * Actividad A
               * Actividad B
               
               ### Fin de Semana: Recuperaci√≥n
               * Actividad C
            
            4. üü¢ LISTAS SOLO PARA DATOS: Usa los puntos (listas) solo cuando enumeres ejercicios o ingredientes.
            
            Si te preguntan algo general que no cay√≥ en el filtro anterior, RECH√ÅZALO amablemente relacion√°ndolo con el cuerpo humano.
            
            TONO: Carism√°tico, enfocado en rendimiento, servicial.`;
        }

        /* --------------------------
           L√ìGICA DEL CHAT CON CORTAFUEGOS MAESTRO (FIREWALL)
        ---------------------------*/
        async function sendMessage(manualText = null) {
            if (!await checkApiKey()) return;

            let input = document.getElementById("userInput");
            let text = manualText || input.value.trim();
            if (!text) return;
            // --- RASTREO EN TIEMPO REAL (MIXPANEL) ---
            if (typeof mixpanel !== 'undefined') {
                mixpanel.track("Mensaje Enviado", {
                    "Usuario": currentUserData ? currentUserData.name : "Desconocido",
                    "Longitud": text.length,
                    "Fecha": new Date().toISOString()
                });
            }

            // 1. Mostrar mensaje del usuario
            appendMessage("T√∫", text, "user", false);
            saveToHistory("user", text);
            input.value = "";
            input.style.height = "auto";
            document.querySelector('.send-btn').classList.remove('valid');
            
            const oldSuggestions = document.querySelector('.suggestions-container');
            if(oldSuggestions) oldSuggestions.remove();

            // ------------------------------------------------------------------
            // 2. üõ°Ô∏è CORTAFUEGOS CONTEXTUAL V5.0 (CONCIERGE BIOL√ìGICO)
            // ------------------------------------------------------------------
            const lowerText = text.toLowerCase();
            
            // --- RADARES (ACTUALIZADOS PARA TAPAR HUECOS) ---
            const mechanicRegex = /(llanta|neumatico|rueda|ponchada|bujia|carburador|motor(?![\s\S]*biologico)|aceite(?![\s\S]*(oliva|coco|cocina))|frenos|clutch|radiador|mecanic|taller|chevrolet|ford|nissan|toyota|coche|carro|camioneta|vehiculo|moto|automovil)/i;
            
            // Agregamos: computadora, laptop, pc, formatear, instalar
            const techRegex = /(computadora|laptop|ordenador|pc|tablet|celular|movil|formatear|instalar|actualizar|tarjeta grafica|gpu|cpu|ram|disco duro|ssd|teclado|mouse|windows|linux|macos|android|\bios\b|excel|powerpoint|word|office|photoshop|programar|codigo|script|python|java|html|css|php|sql|hackear|wifi|\bred\b|internet|inteligencia artificial|chatgpt|gpt|gemini|llm|crypto|bitcoin)/i;
            
            const schoolRegex = /(tarea de|deberes|resumen|ensayo|historia|guerra|batalla|revolucion|geografia|matematicas|algebra|calculo|ecuacion|politica|presidente|elecciones|votar|religion|dios|biblia|poema|literatura|filosofia)/i;
            
            const homeRegex = /(fontanero|plomero|tuber√≠a|electricista|foco|pintar casa|impermeabilizar|lavadora|estufa|refrigerador|jardineria|mueble)/i;
            
            const moneyRegex = /(invertir|dinero|bolsa de valores|prestamo|banco|tarjeta de credito|ganar dinero|millonario|negocio|finanzas)/i;
            
            const loveRegex = /(novia|novio|pareja|\bamor\b|ligar|\bcita\b|romance|sexo|poema de amor|exnovia|esposa|esposo)/i;
            
            const entertainmentRegex = /(pelicula|serie|netflix|cine|videojuego|consola|playstation|xbox|nintendo|meme|chiste|cancion)/i;

            // --- BANCOS DE RESPUESTAS (TONO SERVICIAL Y EMP√ÅTICO) ---
            const denials = {
                mechanic: [
                    "üîß <b>Entiendo el inconveniente con tu veh√≠culo.</b><br>Lamento no poder asistirte con mec√°nica automotriz, mi base de datos es exclusivamente biol√≥gica. Sin embargo, puedo sugerirte ejercicios de respiraci√≥n para mantener la calma mientras lo resuelves.",
                    "üèéÔ∏è <b>S√© que es frustrante cuando la m√°quina falla.</b><br>Aunque no tengo las herramientas para reparar motores, estoy aqu√≠ para asegurarme de que tu cuerpo tenga la energ√≠a necesaria para lidiar con este contratiempo sin agotarte.",
                    "üõë <b>Esa √°rea est√° fuera de mi alcance.</b><br>Para seguridad de tu veh√≠culo, te sugiero consultar a un experto mec√°nico. Yo estar√© aqu√≠ esperando para retomar tu optimizaci√≥n f√≠sica cuando est√©s listo."
                ],
                tech: [
                    "üíª <b>Comprendo que necesitas resolver ese tema t√©cnico.</b><br>Mi sistema no tiene permisos para manipular software o hardware externo (PCs/Celulares). Pero puedo ayudarte a mejorar tu postura o descansar la vista mientras trabajas en ello.",
                    "ü§ñ <b>Lamento la confusi√≥n.</b><br>Aunque soy una IA, estoy dise√±ado espec√≠ficamente para la biolog√≠a humana, no para soporte inform√°tico. ¬øTe gustar√≠a que trabajemos en tu concentraci√≥n para que resuelvas eso m√°s r√°pido?",
                    "üö´ <b>Ese procedimiento t√©cnico no est√° en mis protocolos.</b><br>Para evitar darte un dato err√≥neo sobre tu equipo, prefiero abstenerme. Mi compromiso total es con tu salud y rendimiento. ¬øHay algo de tu bienestar que te preocupe ahora?"
                ],
                school: [
                    "üìö <b>Entiendo la presi√≥n acad√©mica.</b><br>Me encantar√≠a ayudarte, pero hacer tu tarea impedir√≠a que desarrolles tu propia 'fuerza' cognitiva. Lo que s√≠ puedo hacer es recomendarte alimentos que potencien tu memoria y concentraci√≥n ahora mismo.",
                    "üß† <b>El aprendizaje es tu entrenamiento mental.</b><br>No puedo procesar informaci√≥n hist√≥rica o matem√°tica por ti, pero puedo guiarte con t√©cnicas de descanso para que tu cerebro absorba esa informaci√≥n mucho mejor."
                ],
                home: [
                    "üè† <b>Veo que tienes temas dom√©sticos pendientes.</b><br>No cuento con conocimientos de reparaciones del hogar, pero s√© que estas situaciones generan estr√©s. ¬øTe gustar√≠a una recomendaci√≥n r√°pida para bajar los niveles de cortisol?",
                    "‚ö° <b>Esa reparaci√≥n requiere otro tipo de experto.</b><br>Lamento no ser de ayuda con la casa. Mi funci√≥n es asegurar que t√∫, como habitante, tengas la vitalidad y salud √≥ptima para disfrutar de tu hogar."
                ],
                money: [
                    "üí∞ <b>Entiendo tu inter√©s en las finanzas.</b><br>Sin embargo, no estoy capacitado para dar consejos econ√≥micos y no quiero poner en riesgo tu capital. Mi especialidad es maximizar el retorno de inversi√≥n de tu salud.",
                    "üìâ <b>Es un tema importante, pero fuera de mi √°rea.</b><br>Prefiero dejar las estrategias financieras a los expertos. Yo puedo ayudarte a gestionar el estr√©s que a veces provoca el dinero, para que tomes decisiones con la mente clara."
                ],
                love: [
                    "‚ù§Ô∏è <b>Las relaciones humanas son complejas.</b><br>Carezco de la inteligencia emocional para dar consejos de pareja, y no quisiera trivializar tus sentimientos. Pero puedo ayudarte a trabajar en tu confianza y autoestima f√≠sica, que siempre ayuda.",
                    "üß™ <b>Te escucho, pero no soy el indicado.</b><br>Mis algoritmos son biol√≥gicos, no sentimentales. Sin embargo, hacer ejercicio libera endorfinas que podr√≠an ayudarte a sentirte mejor an√≠micamente en este momento."
                ],
                entertainment: [
                    "üé¨ <b>Entiendo que buscas distracci√≥n.</b><br>No tengo acceso a cat√°logos de entretenimiento actual. Pero si est√°s aburrido, ¬øqu√© te parece si probamos un reto f√≠sico r√°pido de 5 minutos para activar tu energ√≠a?",
                    "üéÆ <b>A veces necesitamos desconectar.</b><br>Lamentablemente no s√© de videojuegos o series. Pero si buscas recreaci√≥n, puedo sugerirte actividades al aire libre que beneficiar√°n tu salud."
                ]
            };

            let selectedDenial = null;

            // --- L√ìGICA DE SELECCI√ìN CONTEXTUAL ---
            if (mechanicRegex.test(lowerText)) selectedDenial = denials.mechanic;
            else if (techRegex.test(lowerText)) selectedDenial = denials.tech;
            else if (schoolRegex.test(lowerText)) selectedDenial = denials.school;
            else if (homeRegex.test(lowerText)) selectedDenial = denials.home;
            else if (moneyRegex.test(lowerText)) selectedDenial = denials.money;
            else if (loveRegex.test(lowerText)) selectedDenial = denials.love;
            else if (entertainmentRegex.test(lowerText)) selectedDenial = denials.entertainment;
            else if (/reparar|arreglar|urgente|vital|ayuda/i.test(lowerText)) {
                // Catch-all amable
                selectedDenial = [
                    "‚úã <b>Entiendo que es urgente.</b><br>Sin embargo, mis capacidades est√°n limitadas estrictamente a la biolog√≠a y salud humana. No quiero hacerte perder tiempo en un √°rea que no domino.",
                    "üß¨ <b>Lamento no poder asistir en eso.</b><br>Mi c√≥digo est√° blindado para enfocarse solo en salud y rendimiento. ¬øHay algo relacionado con tu bienestar en lo que s√≠ pueda serte √∫til hoy?"
                ];
            }

            // SI HUBO BLOQUEO, ELEGIMOS FRASE SIN REPETIR
            if (selectedDenial) {
                const loadingId = showLoadingIndicator();
                setTimeout(() => {
                    removeLoadingIndicator(loadingId);
                    
                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * selectedDenial.length);
                    } while (selectedDenial.length > 1 && randomIndex === lastDenialIndex);
                    
                    lastDenialIndex = randomIndex;
                    const msg = selectedDenial[randomIndex];

                    appendMessage("EVYON IA", msg, "bot", true); 
                    saveToHistory("assistant", msg);
                }, 800);
                return; // üõë CORTA LA EJECUCI√ìN
            }

            // 3. Flujo Normal
            const loadingId = showLoadingIndicator();
            const systemPrompt = getDynamicSystemPrompt(text, currentUserData);
            
            let apiMessages = [
                { role: "system", content: systemPrompt },
                ...conversationHistory
            ];

            try {
                let res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: apiMessages,
                        max_tokens: 1000, 
                        temperature: 0.7
                    })
                });

                let data = await res.json();
                removeLoadingIndicator(loadingId);

                if (data.error) {
                    if (data.error.code === 'invalid_api_key') {
                        localStorage.removeItem("evyon_api_key"); apiKey = null;
                        appendMessage("SISTEMA", "API Key inv√°lida.", "bot", false);
                    } else { throw new Error(data.error.message); }
                } else {
                    let botText = data.choices[0].message.content;
                    appendMessage("EVYON IA", botText, "bot", true);
                    saveToHistory("assistant", botText);
                }
            } catch (err) {
                removeLoadingIndicator(loadingId);
                appendMessage("EVYON IA", "‚ö†Ô∏è Error de conexi√≥n.", "bot", false);
            }
        }

        function saveToHistory(role, content) {
            conversationHistory.push({ role, content });
            if (conversationHistory.length > 15) conversationHistory = conversationHistory.slice(conversationHistory.length - 15);
            localStorage.setItem(`evyon_chat_${currentUserData.name}`, JSON.stringify(conversationHistory));
        }

        function loadChatHistory() {
            const saved = localStorage.getItem(`evyon_chat_${currentUserData.name}`);
            const box = document.getElementById("chatBox");
            box.innerHTML = ""; 

            if (saved) {
                conversationHistory = JSON.parse(saved);
                conversationHistory.forEach(msg => {
                    const sender = msg.role === 'user' ? "T√∫" : "EVYON IA";
                    const cssClass = msg.role === 'user' ? "user" : "bot";
                    appendMessage(sender, msg.content, cssClass, false);
                });
            } else {
                appendMessage("EVYON IA", currentUserData.welcome, "bot", false);
                renderSuggestions(currentUserData.suggestions);
            }
        }

        /* --------------------------
           VISUALES & UTILS
        ---------------------------*/
        function formatText(text) {
            // 1. Limpiar l√≠neas horizontales
            let formatted = text.replace(/^\s*---\s*$/gm, '');
            
            // 2. T√≠tulos Grandes (###) -> Verde
            formatted = formatted.replace(/^\s*#{1,6}\s+(.*$)/gm, '<div class="chat-title">$1</div>');
            
            // 3. Negritas Inteligentes
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, function(match, content, offset, fullString) {
                if (fullString[offset + match.length] === ':') return `<strong class="highlight">${content}</strong>`;
                let before = fullString.substring(0, offset).split('\n').pop(); 
                if (/^(\s*|\s*-\s*|\s*\d+\.\s*)$/.test(before)) {
                    return `<strong class="highlight">${content}</strong>`;
                }
                return `<strong>${content}</strong>`;
            });
            
            // 4. Listas
            formatted = formatted.replace(/^(\d+)\.\s+(.*)/gm, '<span class="list-number">$1.</span> $2');
            formatted = formatted.replace(/^- (.*)/gm, '‚Ä¢ $1');
            
            // 5. Saltos de l√≠nea
            formatted = formatted.replace(/\n/g, '<br>');

            // 6. üßº ELIMINAR ESPACIO SOBRANTE TRAS T√çTULOS (ESTA ES LA CLAVE)
            // Si hay un t√≠tulo seguido de un <br>, borramos el <br> para que el CSS controle la distancia.
            formatted = formatted.replace(/<\/div>\s*<br>/g, '</div>');
            
            return formatted;
        }

        function renderSuggestions(list) {
            let box = document.getElementById("chatBox");
            let container = document.createElement("div");
            container.className = "suggestions-container";
            list.forEach(item => {
                let btn = document.createElement("div");
                btn.className = "suggestion-chip";
                btn.innerText = item;
                btn.onclick = () => sendMessage(item);
                container.appendChild(btn);
            });
            box.appendChild(container);
            box.scrollTop = box.scrollHeight;
        }

        function appendMessage(sender, message, type, useTyping) {
            let box = document.getElementById("chatBox");
            let row = document.createElement("div");
            row.className = `message-row ${type}`;

            let avatar = document.createElement("div");
            avatar.className = `avatar ${type}-avatar`;
           // --- INICIO DEL NUEVO C√ìDIGO (Opci√≥n Bio-Luz) ---
            // --- OPCI√ìN 2: HALO ORBITAL ---
            if (type === 'bot') {
                avatar.innerHTML = ""; 
                
                // C√≠rculo vac√≠o
                avatar.style.width = "18px";
                avatar.style.height = "18px";
                avatar.style.borderRadius = "50%";
                avatar.style.border = "2px solid #3cd186"; // El anillo f√≠sico
                avatar.style.background = "transparent";
                avatar.style.margin = "6px";
                
                // Doble brillo (interno y externo)
                avatar.style.boxShadow = "0 0 10px #3cd186, inset 0 0 10px #3cd186";
                avatar.style.animation = "halo-pulse 3s infinite ease-in-out";
                
                if (!document.getElementById('anim-halo')) {
                    let style = document.createElement('style');
                    style.id = 'anim-halo';
                    style.innerHTML = `
                        @keyframes halo-pulse {
                            0% { box-shadow: 0 0 5px #3cd186, inset 0 0 5px #3cd186; opacity: 0.6; }
                            50% { box-shadow: 0 0 20px #3cd186, inset 0 0 15px #3cd186; opacity: 1; border-color: #fff; }
                            100% { box-shadow: 0 0 5px #3cd186, inset 0 0 5px #3cd186; opacity: 0.6; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                avatar.innerHTML = 'üë§';
            }
            // --- FIN DEL NUEVO C√ìDIGO ---

            let bubble = document.createElement("div");
            bubble.className = "message-bubble";
            
            let formattedHtml = formatText(message);
            bubble.innerHTML = formattedHtml;

            if (type === 'bot') {
                row.appendChild(avatar);
                row.appendChild(bubble);
            } else {
                row.appendChild(bubble);
            }

            box.appendChild(row);

            if (type === 'user') {
                box.scrollTop = box.scrollHeight;
            } else {
                setTimeout(() => {
                    row.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 100); 
            }
        }

        function showLoadingIndicator() {
            const id = "loading-" + Date.now();
            let box = document.getElementById("chatBox");
            let row = document.createElement("div");
            row.className = "message-row bot";
            row.id = id;
            
            // 1. Inyectamos la animaci√≥n Piano
            if (!document.getElementById('anim-loading-piano')) {
                let style = document.createElement('style');
                style.id = 'anim-loading-piano';
                style.innerHTML = `
                    @keyframes halo-spin {
                        0% { transform: rotate(0deg); opacity: 0.5; }
                        50% { opacity: 1; }
                        100% { transform: rotate(360deg); opacity: 0.5; }
                    }
                    /* NUEVA ANIMACI√ìN: Salto tipo Piano */
                    @keyframes piano-wave {
                        0%, 100% { transform: translateY(0); color: #64748b; opacity: 0.5; }
                        50% { transform: translateY(-3px); color: #ffffff; opacity: 1; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
                    }
                `;
                document.head.appendChild(style);
            }

            // 2. Generamos las letras separadas para la ola
            const text = "Analizando...";
            let animatedText = "";
            // Creamos un span por cada letra con un retraso progresivo (0.1s)
            text.split("").forEach((char, i) => {
                animatedText += `<span style="display:inline-block; animation: piano-wave 1.4s infinite ease-in-out; animation-delay: ${i * 0.1}s; margin-right: 1px;">${char}</span>`;
            });

            // 3. HTML Final
            row.innerHTML = `
                <div class="avatar" style="
                    width: 32px; height: 32px; 
                    border-radius: 50%; 
                    border: 2px solid #3cd186; 
                    background: transparent; 
                    box-shadow: 0 0 10px #3cd186;
                    animation: halo-spin 1.5s linear infinite;
                    margin-right: 10px;
                "></div>
                <div class="message-bubble" style="
                    background: rgba(255,255,255,0.03); 
                    border: 1px solid rgba(255,255,255,0.05);
                    font-style: normal;
                    font-weight: 500;
                    font-size: 14px;
                    display: flex; align-items: center; /* Alineaci√≥n perfecta */
                ">
                    ${animatedText}
                </div>
            `;

            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function autoResize(textarea) {
            // 1. L√≥gica de Crecimiento (Resetear para calcular bien)
            textarea.style.height = 'auto'; 
            textarea.style.height = (textarea.scrollHeight) + 'px';

            // 2. L√≥gica del Bot√≥n (Prender/Apagar)
            const btn = document.querySelector('.send-btn');
            // Si hay texto real (no solo espacios), activamos la clase .valid
            if (textarea.value.trim().length > 0) {
                btn.classList.add('valid'); 
            } else {
                btn.classList.remove('valid'); 
            }
        }

        function handleChatKey(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        /* (Tus funciones anteriores sendMessage, etc... siguen arriba) */

        /* ==========================================
           CORE DEL EVYON OS (MOTOR DE PART√çCULAS + VOZ)
           ========================================== */
        
        let osActive = false;
        let animationFrameId;
        
        // Variables del Motor
        let particles = [];
        const numParticles = 380; 
        let targetSpeed = 0.0015, currentSpeed = 0.0015;
        let targetScale = 1.0, currentScale = 1.0;
        let targetPulse = 0, currentPulse = 0;
        let glowColor = { r: 0, g: 255, b: 157 }; // Verde Base

        // 1. INICIALIZAR
        function initParticles() {
            particles = [];
            for(let i=0; i<numParticles; i++) {
                const theta = Math.acos(-1 + (2 * i) / numParticles);
                const phi = Math.sqrt(numParticles * Math.PI) * theta;
                particles.push({ 
                    x: Math.sin(theta) * Math.cos(phi), 
                    y: Math.sin(theta) * Math.sin(phi), 
                    z: Math.cos(theta) 
                });
            }
        }

        // 2. DIBUJAR (LOOP 3D)
        function drawCore() {
            if (!osActive) return;
            const canvas = document.getElementById('glassCore');
            const ctx = canvas.getContext('2d');

            // F√≠sicas suaves
            currentSpeed += (targetSpeed - currentSpeed) * 0.05;
            currentScale += (targetScale - currentScale) * 0.05;
            currentPulse += (targetPulse - currentPulse) * 0.1;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const minDim = Math.min(canvas.width, canvas.height);
            const baseRadius = minDim * 0.35 * currentScale;

            ctx.globalCompositeOperation = 'lighter';

            particles.forEach(p => {
                const rx = p.x * Math.cos(currentSpeed) - p.z * Math.sin(currentSpeed);
                const rz = p.x * Math.sin(currentSpeed) + p.z * Math.cos(currentSpeed);
                p.x = rx; p.z = rz;

                const fov = 2.5;
                const scale = fov / (fov + p.z);
                const x2d = cx + (p.x * baseRadius * scale);
                const y2d = cy + (p.y * baseRadius * scale);

                const vibe = (Math.random() - 0.5) * currentPulse;
                const alpha = (scale - 0.5) + (currentPulse * 0.1);
                
                ctx.fillStyle = `rgba(${glowColor.r}, ${glowColor.g}, ${glowColor.b}, ${Math.max(0, alpha)})`;
                ctx.beginPath();
                ctx.arc(x2d + vibe, y2d + vibe, scale * 2.5, 0, Math.PI * 2);
                ctx.fill();
            });

            animationFrameId = requestAnimationFrame(drawCore);
        }

        // 3. ACTIVAR MODO
        function activateNeuralMode() {
            if (!apiKey) { checkApiKey(); return; }
            osActive = true;
            document.getElementById('neural-layer').style.display = 'block';
            
            const canvas = document.getElementById('glassCore');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            
            initParticles();
            
            setTimeout(() => {
                document.getElementById('neural-layer').style.opacity = 1;
                drawCore();
                startVoiceRecognition();
            }, 50);
        }

        // 4. DESACTIVAR MODO
        function deactivateNeuralMode() {
            document.getElementById('neural-layer').style.opacity = 0;
            stopVoiceRecognition();
            setTimeout(() => {
                osActive = false;
                cancelAnimationFrame(animationFrameId);
                document.getElementById('neural-layer').style.display = 'none';
            }, 500);
        }

        /* --- L√ìGICA DE VOZ --- */
        let recognition;
        
        function setOSState(state) {
            const statusEl = document.getElementById('osStatus');
            const hud = document.querySelector('.hud-overlay');
            hud.className = 'hud-overlay'; 

            if (state === 'listening') {
                targetSpeed = 0.0005; targetPulse = 1.5; targetScale = 1.1;
                glowColor = { r: 255, g: 255, b: 255 }; 
                statusEl.innerText = "ESCUCHANDO...";
                hud.classList.add('hud-listening');
            } 
            else if (state === 'speaking') {
                targetSpeed = 0.005; targetPulse = 8.0; targetScale = 1.0;
                glowColor = { r: 0, g: 255, b: 157 }; 
                statusEl.innerText = "EVYON HABLANDO";
                hud.classList.add('hud-speaking');
            }
            else { 
                targetSpeed = 0.0015; targetPulse = 0; targetScale = 1.0;
                glowColor = { r: 0, g: 220, b: 255 }; 
                statusEl.innerText = "ENLACE NEURAL ACTIVO";
            }
        }

        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("Navegador no soporta voz"); return; }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'es-MX';
            recognition.interimResults = false;
            
            recognition.onstart = () => setOSState('listening');
            
            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                setOSState('processing');
                
                appendMessage("T√∫", transcript, "user", false);
                saveToHistory("user", transcript);

                try {
                    const voicePrompt = getDynamicSystemPrompt(transcript, currentUserData) + " [RESPONDE BREVE MAX 2 ORACIONES]";
                    let res = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: "gpt-4o-mini",
                            messages: [{ role: "system", content: voicePrompt }, ...conversationHistory],
                            max_tokens: 150
                        })
                    });
                    let data = await res.json();
                    let reply = data.choices[0].message.content;

                    appendMessage("EVYON IA", reply, "bot", true);
                    saveToHistory("assistant", reply);
                    speakResponse(reply);

                } catch (e) { console.error(e); setOSState('idle'); }
            };
            recognition.start();
        }

        function stopVoiceRecognition() {
            if (recognition) recognition.stop();
        }

        async function speakResponse(text) {
            setOSState('speaking');
            try {
                const res = await fetch("https://api.openai.com/v1/audio/speech", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "tts-1", voice: "nova", input: text })
                });
                const blob = await res.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.onended = () => { try { recognition.start(); } catch(e){} };
                audio.play();
            } catch (err) { setOSState('idle'); }
        }
    </script> 
    <div id="neural-layer" style="display:none; opacity:0;">
        <div class="neural-bg"></div>
        <canvas id="glassCore"></canvas>
        <div class="hud-overlay">
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
        </div>
        <div class="os-interface">
            <div class="os-status" id="osStatus">ENLACE NEURAL ACTIVO</div>
            <button class="disconnect-btn" onclick="deactivateNeuralMode()">
                [ CERRAR ENLACE DE VOZ ]
            </button>
        </div>
    </div>
    
</body>
</html>
